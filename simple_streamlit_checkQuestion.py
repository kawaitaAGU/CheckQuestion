import streamlit as st
from PIL import Image
import base64
from openai import OpenAI

# OpenAI APIã‚­ãƒ¼ã®è¨­å®šï¼ˆStreamlit Secretsã‹ã‚‰ï¼‰
client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])

# Streamlitç”»é¢è¨­å®š
st.set_page_config(page_title="å•é¡Œæ ¡æ­£", layout="centered")
st.title("ğŸ¦· Simpleå•é¡Œç”»åƒã‹ã‚‰æ ¡æ­£ãƒã‚§ãƒƒã‚¯ï¼ˆGPT-4o VISIONï¼‰")

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¬„
uploaded_file = st.file_uploader("ğŸ“„ æ­¯ç§‘åŒ»å¸«å›½å®¶è©¦é¨“ã®å•é¡Œç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„", type=["png", "jpg", "jpeg"])

if uploaded_file:
    image = Image.open(uploaded_file)
    st.image(image, caption="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ", use_column_width=True)

    with st.spinner("ğŸ” GPT-4o Visionã§è§£æãƒ»æ ¡æ­£ä¸­..."):

        # base64å½¢å¼ã«ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
        image_bytes = uploaded_file.getvalue()
        base64_image = base64.b64encode(image_bytes).decode()

        # OpenAI Vision APIã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        response = client.chat.completions.create(
            model="gpt-4o-2024-11-20",
            messages=[
                {
                    "role": "system",
                    "content": "ã‚ãªãŸã¯æ­¯ç§‘åŒ»å¸«å›½å®¶è©¦é¨“å•é¡Œã®æ ¡æ­£è€…ã§ã™ã€‚"
                },
                {
                    "role": "user",
                    "content": [
                        {
                            "type": "text",
                            "text": """ã“ã®ç”»åƒã«ã¯ã€æ­¯ç§‘åŒ»å¸«å›½å®¶è©¦é¨“ã®å½¢å¼ã«æº–ã˜ãŸå•é¡Œãƒ»é¸æŠè‚¢ãƒ»æ­£è§£ãƒ»è§£èª¬ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚

æ­£ç­”ã¯ã€Œè§£ç­”ï¼šã€ã€Œæ­£è§£ï¼šã€ãªã©ã®ã‚ã¨ã«æ˜ç¤ºã•ã‚Œã¾ã™ãŒã€ãã‚ŒãŒã€Œå•é¡Œç•ªå·ã€ã§ã¯ãªãã€Œæ­£ã—ã„é¸æŠè‚¢ç•ªå·ã€ã‚’ç¤ºã—ã¦ã„ã‚‹ã“ã¨ã‚’ç†è§£ã—ã€æ­£ç¢ºã«èª­ã¿å–ã£ã¦ãã ã•ã„ï¼ˆä¾‹ï¼šã€Œè§£ç­”ï¼š14ã€ã¯é¸æŠè‚¢ç•ªå·1ã¨4ã®æ„å‘³ï¼‰ã€‚ä»–ã®æ•°å­—ã«æƒ‘ã‚ã•ã‚Œãªã„ã‚ˆã†æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®ç‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€å„å•é¡Œã”ã¨ã«ç°¡æ½”ã«æ•´ç†ã—ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼š

1. å•é¡Œæ–‡ã¨é¸æŠè‚¢ãŒè«–ç†çš„ãƒ»åŒ»å­¦çš„ã«å¦¥å½“ã‹ã€‚
2. å„é¸æŠè‚¢ãŒæ­£ã—ã„ã‹èª¤ã£ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡ã€‚
3. ã€Œâ—‹ã¤é¸ã¹ã€ã®æŒ‡ç¤ºã¨æ­£è§£æ•°ãŒæ•´åˆã—ã¦ã„ã‚‹ã‹ã€‚
4. ç”»åƒå†…ã®æ­£ç­”ã¨ã‚ãªãŸã®ç­”ãˆãŒä¸€è‡´ã™ã‚‹ã‹ï¼ˆç•°ãªã‚‹å ´åˆã¯ç†ç”±ã‚’è¿°ã¹ã¦å ±å‘Šï¼‰ã€‚
5. å°‚é–€ç”¨èªã‚„è¡¨è¨˜ã«èª¤å­—ãƒ»è„±å­—ãƒ»ç”¨èªãƒŸã‚¹ãŒãªã„ã‹ã€‚
6. å›½å®¶è©¦é¨“å•é¡Œã¨ã—ã¦ã®å½¢å¼ï¼ˆé¸æŠè‚¢ã®ä½“è£ã‚„è¨­å•æ§‹é€ ï¼‰ãŒé©åˆ‡ã‹ã€‚
7. è§£èª¬ãŒã‚ã‚‹å ´åˆã€ãã®å†…å®¹ãŒå¦¥å½“ã‹ã€‚

â€» å•é¡Œå†…ã®æ­£ç­”ã¯é–“é•ã£ã¦ã„ã‚‹ã“ã¨ã‚‚ã‚ã‚‹ãŸã‚ã€å¿–åº¦ã›ãšå³å¯†ã«åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚"""
                        },
                        {
                            "type": "image_url",
                            "image_url": {
                                "url": f"data:image/jpeg;base64,{base64_image}"
                            }
                        }
                    ]
                }
            ],
            temperature=0.2,
            max_tokens=4096
        )

        # çµæœå‡ºåŠ›
        result = response.choices[0].message.content

    st.subheader("ğŸ“˜ æ ¡æ­£çµæœ")
    st.markdown(result)
